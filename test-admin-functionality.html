<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Functionality Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Admin Panel Functionality Test</h1>
    <p>This page will help diagnose issues with the admin panel functionality.</p>

    <div class="test-section">
        <h2>1. Environment Configuration</h2>
        <button onclick="testEnvironment()">Test Environment Variables</button>
        <div id="env-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Supabase Connection</h2>
        <button onclick="testSupabaseConnection()">Test Database Connection</button>
        <div id="supabase-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Authentication Test</h2>
        <div>
            <input type="email" id="test-email" placeholder="Admin Email" style="padding: 8px; width: 200px; margin: 5px;">
            <input type="password" id="test-password" placeholder="Password" style="padding: 8px; width: 200px; margin: 5px;">
            <button onclick="testAuth()">Test Login</button>
        </div>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Database Operations Test</h2>
        <button onclick="testDatabaseOps()">Test CRUD Operations</button>
        <div id="db-ops-result"></div>
    </div>

    <div class="test-section">
        <h2>5. API Endpoints Test</h2>
        <button onclick="testAPIEndpoints()">Test All Endpoints</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h2>6. Console Errors</h2>
        <button onclick="checkConsoleErrors()">Check Browser Console</button>
        <div id="console-result"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // Store supabase client globally
        window.supabaseClient = null;

        window.testEnvironment = function() {
            const result = document.getElementById('env-result');
            result.innerHTML = '<div class="test-result info">Testing environment configuration...</div>';

            try {
                const envVars = {
                    'VITE_SUPABASE_URL': import.meta.env.VITE_SUPABASE_URL,
                    'VITE_SUPABASE_ANON_KEY': import.meta.env.VITE_SUPABASE_ANON_KEY ? '‚úì Present' : '‚úó Missing'
                };

                let html = '<div class="test-result success"><strong>Environment Variables:</strong><pre>' + 
                    JSON.stringify(envVars, null, 2) + '</pre></div>';

                if (!import.meta.env.VITE_SUPABASE_URL || !import.meta.env.VITE_SUPABASE_ANON_KEY) {
                    html += '<div class="test-result error"><strong>‚ùå ERROR:</strong> Supabase credentials not found!<br>' +
                        'Please ensure .env file exists with:<br>' +
                        '<pre>VITE_SUPABASE_URL=your_url\nVITE_SUPABASE_ANON_KEY=your_key</pre></div>';
                }

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="test-result error"><strong>‚ùå ERROR:</strong> ${error.message}</div>`;
            }
        };

        window.testSupabaseConnection = async function() {
            const result = document.getElementById('supabase-result');
            result.innerHTML = '<div class="test-result info">Testing Supabase connection...</div>';

            try {
                const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
                const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Supabase credentials not configured');
                }

                window.supabaseClient = createClient(supabaseUrl, supabaseKey);

                // Test connection by querying rooms table
                const { data, error, count } = await window.supabaseClient
                    .from('rooms')
                    .select('*', { count: 'exact', head: false })
                    .limit(5);

                if (error) throw error;

                let html = '<div class="test-result success"><strong>‚úì Connection Successful!</strong><br>';
                html += `Found ${count || 0} rooms in database.<br>`;
                if (data && data.length > 0) {
                    html += '<strong>Sample data:</strong><pre>' + JSON.stringify(data[0], null, 2) + '</pre>';
                }
                html += '</div>';

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="test-result error"><strong>‚ùå Connection Failed:</strong><br>${error.message}<br>
                    <strong>Possible issues:</strong><ul>
                    <li>Invalid Supabase URL or API key</li>
                    <li>Network connection issues</li>
                    <li>Database permissions/RLS policies</li>
                    </ul></div>`;
            }
        };

        window.testAuth = async function() {
            const result = document.getElementById('auth-result');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            if (!email || !password) {
                result.innerHTML = '<div class="test-result error">Please enter email and password</div>';
                return;
            }

            result.innerHTML = '<div class="test-result info">Testing authentication...</div>';

            try {
                // Call the Netlify function
                const response = await fetch('/.netlify/functions/simple-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'login',
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Authentication failed');
                }

                if (data.user && data.user.is_admin) {
                    result.innerHTML = `<div class="test-result success"><strong>‚úì Authentication Successful!</strong><br>
                        User: ${data.user.first_name} ${data.user.last_name}<br>
                        Email: ${data.user.email}<br>
                        Admin: ${data.user.is_admin ? 'Yes' : 'No'}</div>`;
                } else {
                    result.innerHTML = `<div class="test-result error"><strong>‚ùå Not an admin user!</strong></div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result error"><strong>‚ùå Authentication Failed:</strong><br>${error.message}</div>`;
            }
        };

        window.testDatabaseOps = async function() {
            const result = document.getElementById('db-ops-result');
            result.innerHTML = '<div class="test-result info">Testing database operations...</div>';

            if (!window.supabaseClient) {
                result.innerHTML = '<div class="test-result error">Please run Supabase connection test first</div>';
                return;
            }

            let html = '';
            let allPassed = true;

            try {
                // Test READ operation
                const { data: rooms, error: readError } = await window.supabaseClient
                    .from('rooms')
                    .select('*')
                    .limit(1);

                if (readError) {
                    html += `<div class="test-result error">‚ùå READ Failed: ${readError.message}</div>`;
                    allPassed = false;
                } else {
                    html += `<div class="test-result success">‚úì READ Operation: Working</div>`;
                }

                // Test other tables
                const tables = ['bookings', 'testimonials', 'features', 'attractions'];
                for (const table of tables) {
                    const { error } = await window.supabaseClient
                        .from(table)
                        .select('count', { count: 'exact', head: true });

                    if (error) {
                        html += `<div class="test-result error">‚ùå Table '${table}': ${error.message}</div>`;
                        allPassed = false;
                    } else {
                        html += `<div class="test-result success">‚úì Table '${table}': Accessible</div>`;
                    }
                }

                if (allPassed) {
                    html = '<div class="test-result success"><strong>‚úì All database operations working!</strong></div>' + html;
                }

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="test-result error"><strong>‚ùå Database operations failed:</strong><br>${error.message}</div>`;
            }
        };

        window.testAPIEndpoints = async function() {
            const result = document.getElementById('api-result');
            result.innerHTML = '<div class="test-result info">Testing API endpoints...</div>';

            const endpoints = [
                { name: 'Login Function', path: '/.netlify/functions/simple-login' }
            ];

            let html = '';
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.path, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'test' })
                    });

                    if (response.status === 404) {
                        html += `<div class="test-result error">‚ùå ${endpoint.name}: Not Found (404)</div>`;
                    } else {
                        html += `<div class="test-result success">‚úì ${endpoint.name}: Responding (${response.status})</div>`;
                    }
                } catch (error) {
                    html += `<div class="test-result error">‚ùå ${endpoint.name}: ${error.message}</div>`;
                }
            }

            result.innerHTML = html;
        };

        window.checkConsoleErrors = function() {
            const result = document.getElementById('console-result');
            result.innerHTML = `<div class="test-result info">
                <strong>Check Browser Console (F12):</strong><br>
                1. Open Developer Tools (F12 or Right-click ‚Üí Inspect)<br>
                2. Go to Console tab<br>
                3. Look for any red error messages<br>
                4. Common issues to look for:<br>
                <ul>
                    <li>CORS errors</li>
                    <li>Failed to fetch errors</li>
                    <li>Undefined variable errors</li>
                    <li>Network request failures</li>
                </ul>
            </div>`;
        };

        // Auto-run environment test on load
        window.addEventListener('load', () => {
            testEnvironment();
        });
    </script>
</body>
</html>
